<html>
<head>
	<title>Build Part from Dom Spec</title>
	<script src="../lib/jquery-1.3.2.js"></script>
	<script src="screw.unit.dependencies.js"></script>
	<script src="test_extensions.js"></script>
	<script src="../src/coconut.js"></script>
</head>
<body>

<div id="fixture">
	<div id="person">
		<input type="text" value="luning" name="name"></input>
		<select name="title">
			<option selected="selected">please select</option>
			<option>Mr</option>
			<option>Mrs</option>
		</select>
		<div>
			<input type="radio" value="Male" checked="checked" name="gender">Male</input>
			<input type="radio" value="Female" name="gender">Female</input>
		</div>
		<div part="" name="dob">
			<select name="day">
				<option selected="selected">please select</option>
				<option>01</option>
				<option>02</option>
			</select>
			<select name="month">
				<option selected="selected">please select</option>
				<option>Jan</option>
				<option>Feb</option>
			</select>
			<select name="year">
				<option selected="selected">please select</option>
				<option>1990</option>
				<option>1991</option>
			</select>
		</div>
		<input id="nationality" type="text" someproperty="nationality"></input>
		<input id="id_city" type="text" fieldname="city"></input>
		<div class="emails">
			<input type="text" fieldtype="array,.emails" value="luning.tw@gmail.com" name="email"></input>
		</div>
		<div part="" fieldtype="array" name="contact">
			<input type="text" name="number"></input>
			<input type="text" name="type"></input>
		</div>
	</div>
	<input id="randomInput" type="text"></input>
</div>
	
<script type="text/javascript">
Screw.Unit(function() {

	var fixtureHtml = $("#fixture").html();

	before(function() {
		$("#fixture").html(fixtureHtml);
	});

	describe("Build Part", function() {
		it("should capture text input in dom", function() {
			var person = $("#person").part();
			expect(person.name.state()).to(equal, "luning");
		});		
		
		it("should capture select in dom", function() {
			var person = $("#person").part();
			person.title.state("Mrs");
			expect(person.title.state()).to(equal, "Mrs");
		});		
		
		it("should capture radio in dom", function() {
			var person = $("#person").part();
			person.gender.state("Female");
			expect(person.gender.state()).to(equal, "Female");
		});	
		
		it("should ensure unique field name", function() {
			$("select[name=title]").attr("name", "name");
			
			try{
				var person = $("#person").part();
				expect(true).to(be_false);
			} catch (ex){
				expect(ex.toString()).to(match, "CoconutError");
			}
		});
		
		it("should use id as field name if name property is not provided", function() {
			var person = $("#person").part();
			person.nationality.state("OZ");
			expect(person.nationality.state()).to(equal, "OZ");
		});		
		
		it("should use field name defined by 'fieldname' property in dom", function() {
			var person = $("#person").part();
			expect(person.hasOwnProperty("id_city")).to(be_false);
			
			person.city.state("sydney");
			expect(person.city.state()).to(equal, "sydney");
		});		
		
		it("should ignore dom element if field name can not be determined", function() {
			var nationalityDom = $("#nationality").removeAttr("id").get(0);

			var person = $("#person").part();
			expect($.inArray(nationalityDom, person.get())).to(equal, -1);
		});		
		
		it("should not create convenient field accessor if it will override existng property of part", function() {
			$("select[name=title]").attr("name", "isDirty");
			
			var person = $("#person").part();
			expect(person.isDirty.state).to(be_undefined);
			expect($.isFunction(person.isDirty)).to(be_true);
		});
		
		it("should build field of array type for element if 'fieldtype' property is setted to 'array' in dom", function() {
			var person = $("#person").part();
			
			expect(person.email).to(be_undefined);
			expect(person.emails.length).to(equal, 1);
			expect(person.emails[0].state()).to(equal, "luning.tw@gmail.com");
			
			expect(person.state()).to(contain_object, {emails:["luning.tw@gmail.com"]});
		});
		
		it("should add the following fields to array if the name is supposed to be of array type", function() {
			$("#person").append("<input type='text' name='email'></input>");
			
			var person = $("#person").part();
			expect(person.email).to(be_undefined);
			expect(person.emails.length).to(equal, 2);
			
			var s = {emails: ["one@my.com", "another@my.com"]};
			person.state(s);
			expect(person.state()).to(contain_object, s);
		});

		it("should build array field of part type", function() {
			var person = $("#person").part();
			expect(person.contact).to(be_undefined);
			expect(person.contacts.length).to(equal, 1);
			
			var s = {contacts: [{number: "123456789", type: "office"}]};
			person.state(s)
			expect(person.state()).to(contain_object, s);
		});
		
		it("should build array field with container if specified in 'fieldtype' property", function() {
			var person = $("#person").part();

			expect(person.emails.container[0]).to(equal, $("#person div.emails")[0]);
		});
		
		it("should build array field without container if not specified in 'fieldtype' property", function() {
			var person = $("#person").part();

			expect(person.contacts.container).to(be_undefined);
		});
		
		it("should capture hidden dom element", function() {
			// TODO : 
		});
		
		it("should ignore hidden template dom element", function() {
			// TODO : 
		});
	});

	describe("Build Part with another Part as Field", function() {
		it("should pick part specified in dom as field of parent part", function() {
			var person = $("#person").part();
			var dobState = {day: "01", month: "Feb", year: "1991"};
			person.dob.state(dobState);
			
			expect(person.dob.state()).to(equal_object, dobState);
			expect(person.day).to(be_undefined);
			expect(person.month).to(be_undefined);
			expect(person.year).to(be_undefined);
		});
		
		it("should pick constructor behaviour specified in dom", function() {
			window.Dob = function(){
				this.description = function(){
					return this.day.state() + " " + this.month.state() + " " + this.year.state();
				}
			};
			
			$("div[name=dob]").attr("part", "Dob");
			
			var person = $("#person").part();
			person.dob.state({day: "01", month: "Feb", year: "1991"});
			
			expect(person.dob.description()).to(equal, "01 Feb 1991");
		});
	});

	describe("Build Part with Behaviour", function() {

		it("should mixin method defined in behaviour", function() {
			function Person(){};
			Person.prototype = {
				getNameAndGender: function(){
					return this.name.state() + "," + this.gender.state();
				}
			};
			
			var person = $("#person").part(Person);
			person.state({name:"smith", gender:"Female"});
			
			expect(person.getNameAndGender()).to(equal, "smith,Female");
		});		
		
		it("should capture initial state after constructor behaviour is applied", function() {
			function Person(){
				this.name.state("smith");
			};
			
			var person = $("#person").part(Person);
			person.resetState();
			
			expect(person.name.state()).to(equal, "smith");
		});		
		
		it("should pick behaviour specified in dom", function() {
			$("#person").attr("part", "Person");
			
			window.Person = function(){
				this.getSomething = "something";
			};
			
			var person = $("#person").part();
			
			expect(person.getSomething).to(equal, "something");
		});		
		
		it("should be able to add behaviour after construction", function() {
			function SayHello(){
				this.helloMessage = "hello";
			};
			
			var person = $("#person").part().addBehaviour(SayHello);
			
			expect(person.helloMessage).to(equal, "hello");
		});		
		
		it("should not affect initial state for behaviour added after construction", function() {
			function Person(){
				this.name.state("smith");
			};
			
			var person = $("#person").part()
							.addBehaviour(Person)
							.resetState();
			
			expect(person.name.state()).to(equal, "luning");
		});		

	});
	
	describe("State Operations", function() {
		it("should get/set state of a part", function() {
			var person = $("#person").part();
			var state = { name: "josh", title: "Mrs", gender: "Male", nationality: "OZ", city: "sydney" };
			person.state(state);
			expect(person.state()).to(contain_object, state);
		});		
		
		it("should be dirty if any field is changed after creation", function() {
			var person = $("#person").part();
			expect(person.isDirty()).to(be_false);
			
			person.name.state(person.name.state()); // setting without change
			expect(person.isDirty()).to(be_false);
			
			person.name.state("smith");
			expect(person.isDirty()).to(be_true);
		});			
		
		it("should reset initial state", function() {
			var person = $("#person").part();
			var initialState = person.state();
			
			person.state({ name: "josh", title: "Mrs", gender: "Male", nationality: "OZ", city: "sydney" });
			
			person.resetState();
			expect(person.state()).to(equal_object, initialState);
		});	
		
		it("should reset initial state with specific fields", function() {
			var person = $("#person").part();
			var initialState = person.state();
			var tempState = { name: "josh", title: "Mrs", gender: "Male", nationality: "OZ", city: "sydney" };
			person.state(tempState);
			
			person.resetState("name", "title");
			var finalState = person.state();
			
			expect(finalState.name).to(equal, initialState.name);
			expect(finalState.title).to(equal, initialState.title);
			
			expect(finalState.gender).to(equal, tempState.gender);
			expect(finalState.nationality).to(equal, tempState.nationality);
			expect(finalState.city).to(equal, tempState.city);
		});	
		
		it("should not reset state with non-exist field", function() {
			var person = $("#person").part();
			
			try{
				person.resetState("notexist");
				expect(true).to(be_false);
			} catch(ex){
				expect(ex.toString()).to(match, "CoconutError");
			}
		});	
				
		it("should know need or not to update this part with another state", function() {
			var person = $("#person").part();
			
			expect(person.needUpdateWith({name: "smith"})).to(be_true);
			expect(person.needUpdateWith({name: "luning"})).to(be_false);
		});	
		
		it("should be able to capture initial state even after construction", function() {
			var person = $("#person").part()
							.state({name: "smith"})
							.captureInitialState()
							.resetState();
			
			expect(person.name.state()).to(equal, "smith");
		});

		describe("State of Composite Part", function() {

			it("should get/set state of object hierarchy", function() {
				var person = $("#person").part();
				var dobState = {day: "01", month: "Feb", year: "1991"};

				person.state({ dob: dobState });
				expect(person.state()).to(contain_object, {dob: dobState});
			});

			it("should get/set state of flaten object", function() {
			    // TODO : expect(true).to(be_false);
			});

		});

	});
	
	describe("Part Dom Sync", function() {
		describe("adding dom element dynamicly", function() {
			it("should add field if applicable", function() {
				var person = $("#person").part();
				var edu = $("<input type='text' name='education'></input>");
				person.title.after(edu);
				edu.sync();
				
				person.education.state("college");
				expect(person.education.state()).to(equal, "college");
			});	

			it("should add field once even if call sync twice", function() {
				var person = $("#person").part();
				var edu = $("<input type='text' name='education'></input>");
				person.title.after(edu);
				edu.sync();
				edu.sync();
				
				person.education.state("college");
				expect(person.education.state()).to(equal, "college");
			});
			
			it("should add field with proper field order", function() {
				var person = $("#person").part();
				var edu = $("<input type='text' name='education'></input>");
				person.title.after(edu);
				edu.sync();
				
				expect(person.index("education")).to(equal, person.index("title") + 1);
			});
			
			it("should add part type field if applicable, and in correct order", function() {
				var person = $("#person").part();
				var edu = $("<div part name='education'><input type='text' name='college'></input></div>");
				person.title.after(edu);
				edu.sync();
				
				person.education.state({college: "UTS"});
				
				expect(person.education.state()).to(equal_object, {college: "UTS"});
				expect(person.index("education")).to(equal, person.index("title") + 1);
			});
			
			it("should create array field if 'fieldtype' is setted to 'array'", function() {
				var person = $("#person").part();
				
				var hobby = $("<input type='text' value='reading' fieldtype='array' name='hobby'></input>");
				$("#person").append(hobby);
				hobby.sync();
				
				expect(person.hobby).to(be_undefined);
				expect(person.hobbies).to_not(be_undefined);
				expect(person.hobbies.length).to(equal, 1);
				expect(person.hobbies[0].state()).to(equal, "reading");
			});
			
			it("should add field to array if the name is supposed to be of array type", function() {
				var person = $("#person").part();
				expect(person.emails.length).to(equal, 1);
				
				var anotherEmail = $("<input type='text' value='another@my.com' name='email'></input>");
				$("#person").append(anotherEmail);
				anotherEmail.sync();
				
				expect(person.email).to(be_undefined);
				expect(person.emails.length).to(equal, 2);
				expect(person.emails[1].state()).to(equal, "another@my.com");
			});
			
			it("should add field to array once even if call sync twice", function() {
				var person = $("#person").part();
				expect(person.emails.length).to(equal, 1);
				
				var anotherEmail = $("<input type='text' value='another@my.com' name='email'></input>");
				$("#person").append(anotherEmail);
				anotherEmail.sync();
				anotherEmail.sync();
				
				expect(person.email).to(be_undefined);
				expect(person.emails.length).to(equal, 2);
			});
			
			it("should add part type field to array if the name is supposed to be of array type", function() {
				var person = $("#person").part();
				expect(person.contacts.length).to(equal, 1);

				var anotherContact = $("<div part='' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
				$("#person").append(anotherContact);
				anotherContact.sync();
				
				expect(person.contact).to(be_undefined);
				expect(person.contacts.length).to(equal, 2);
				expect(person.contacts[1].state()).to(equal_object, {number: "111", type: "home"});
			});

		});

		describe("removing dom element dynamicly", function() {

			it("should remove field accordingly", function() {
				var person = $("#person").part();
				person.container.find("input[name=name]").remove();
				person.sync();
				
				expect(person.has("name")).to(be_false);
				expect(person.name).to(be_undefined);
			});
			
			it("should remove item in array field accordingly", function() {
				var anotherEmail = $("<input type='text' name='email'></input>");
				$("#person").append(anotherEmail);
				
				var person = $("#person").part();
				expect(person.emails.length).to(equal, 2);
				
				anotherEmail.remove();
				person.sync();
				
				expect(person.emails).to_not(be_undefined);
				expect(person.emails.length).to(equal, 1);
				expect(person.emails[0].state()).to(equal, "luning.tw@gmail.com");
			});
			
			it("should remove the array field associated with no container if it becomes empty", function() {
				$("#person input[fieldtype='array,.emails']").attr("fieldtype", "array"); // removed container setting
			
				var person = $("#person").part();
				expect(person.emails.length).to(equal, 1);
				
				person.container.find("input[name=email]").remove();
				person.sync();
				
				expect(person.has("emails")).to(be_false);
				expect(person.emails).to(be_undefined);
			});
			
			it("should not remove the array field associated with a container even if it becomes empty", function() {
				var person = $("#person").part();
				expect(person.emails.length).to(equal, 1);
				
				person.container.find("input[name=email]").remove();
				person.sync();
				
				expect(person.has("emails")).to(be_true);
				expect(person.emails.length).to(equal, 0);
			});

			it("should remove part in array field accordingly", function() {
				var anotherContact = $("<div part='' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
				$("#person").append(anotherContact);
				
				var person = $("#person").part();
				expect(person.contacts.length).to(equal, 2);
				
				anotherContact.remove();
				person.sync();
				
				expect(person.contacts.length).to(equal, 1);
				expect(person.contacts[0].state()).to(equal_object, { number: "", type: "" });
			});
			
			it("should remove the array field containing parts if it becomes empty", function() {
				$("#person").append("<div part='' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
				
				var person = $("#person").part();
				expect(person.contacts.length).to(equal, 2);

				$("#person div[name=contact]").remove();
				person.sync();
				
				expect(person.has("contacts")).to(be_false);
				expect(person.contacts).to(be_undefined);
			});
			
		});
	});

	describe("Field Operations", function() {

		it("should set up field order", function() {
			var person = $("#person").part(function Person(){
				this.orderFields("gender", "title", "name");
			});
			expect(person.index("gender")).to(equal, person.index("title") - 1);
			expect(person.index("title")).to(equal, person.index("name") - 1);
		});			

		it("should not set up field order with invalid names", function() {
			try{
				var person = $("#person").part(function Person(){
					this.orderFields("gender", "invalidname");
				});
				expect(true).to(be_false);
			} catch(ex) {
				expect(ex.toString()).to(match, "CoconutError");
			}
		});			
		
		it("should add field ignored during construction", function() {
			$("#nationality").removeAttr("id"); // #nationality will be ignored

			var person = $("#person").part(function Person(){
				this.addFields({
					nationality: "input[someproperty=nationality]"
				});
			});
			
			person.nationality.state("OZ");
			expect(person.nationality.state()).to(equal, "OZ");
		});			
		
		it("should not add field for dom element which is already captured by other field", function() {
			try{
				var person = $("#person").part(function Person(){
					this.addFields({
						myField: "#nationality"
					});
				});
				expect(true).to(be_false);
			} catch(ex) {
				expect(ex.toString()).to(match, "CoconutError");
			}
		});			
		
		it("should not add field without matched dom element", function() {
			try{
				var person = $("#person").part(function Person(){
					this.addFields({
						notexist: "#notexist"
					});
				});
				expect(true).to(be_false);
			} catch(ex) {
				expect(ex.toString()).to(match, "CoconutError");
			}
		});		
		
		it("should not add field with duplicated name", function() {
			$("#nationality").removeAttr("id"); // #nationality will be ignored

			try{
				var person = $("#person").part(function Person(){
					this.addFields({
						name: "[someproperty=nationality]"
					});
				});
				expect(true).to(be_false);
			} catch(ex) {
				expect(ex.toString()).to(match, "CoconutError");
			}
		});		

	});
});
</script>
</body>
</html>