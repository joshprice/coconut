<html>
<head>
  <title>Part Dom Sync Spec</title>
  <script src="../lib/jquery-1.3.2.js"></script>
  <script src="lib/screw.dependencies.js"></script>
  <script src="lib/test.helper.js"></script>
  <script src="../src/jquery.coconut.js"></script>
</head>
<body>

<div id="fixture">
  <div id="person">
    <input type="text" value="luning" name="name"></input>
    <select name="title">
      <option selected="selected">please select</option>
      <option>Mr</option>
      <option>Mrs</option>
    </select>
    <div>
      <input type="radio" value="Male" checked="checked" name="gender">Male</input>
      <input type="radio" value="Female" name="gender">Female</input>
    </div>
    <div part="" name="dob">
      <select name="day">
        <option selected="selected">please select</option>
        <option>01</option>
        <option>02</option>
      </select>
      <select name="month">
        <option selected="selected">please select</option>
        <option>Jan</option>
        <option>Feb</option>
      </select>
      <select name="year">
        <option selected="selected">please select</option>
        <option>1990</option>
        <option>1991</option>
      </select>
    </div>
    <input id="nationality" type="text" someproperty="nationality"></input>
    <input id="id_city" type="text" fieldname="city"></input>
    <div class="emails">
      <input type="text" fieldtype="array,.emails" value="luning.tw@gmail.com" name="email"></input>
    </div>
    <div part="" fieldtype="array" name="contact">
      <input type="text" name="number"></input>
      <input type="text" name="type"></input>
    </div>
  </div>
  <input id="randomInput" type="text"></input>
</div>

<script type="text/javascript">
Screw.Unit(function() {

  var fixtureHtml = $("#fixture").html();
  var person;

  before(function() {
    $("#fixture").html(fixtureHtml);
    
    person = $("#person").part();
  });

  describe("Add Dom Dynamicly", function() {
    it("should add field if applicable", function() {
      var edu = $("<input type='text' name='education'></input>");
      person.title.after(edu);
      edu.sync();

      person.education.state("college");
      expect(person.education.state()).to(equal, "college");
    });

    it("should add field once even if call sync twice", function() {
      var edu = $("<input type='text' name='education'></input>");
      person.title.after(edu);
      edu.sync();
      edu.sync();

      person.education.state("college");
      expect(person.education.state()).to(equal, "college");
    });

    it("should add field with proper field order", function() {
      var edu = $("<input type='text' name='education'></input>");
      person.title.after(edu);
      edu.sync();

      expect(person.index("education")).to(equal, person.index("title") + 1);
    });

    it("should add part type field if applicable, and in correct order", function() {
      var edu = $("<div part name='education'><input type='text' name='college'></input></div>");
      person.title.after(edu);
      edu.sync();

      person.education.state({college: "UTS"});

      expect(person.education.state()).to(equal_state, {college: "UTS"});
      expect(person.index("education")).to(equal, person.index("title") + 1);
    });

    it("should create array field if 'fieldtype' is setted to 'array'", function() {
      var hobby = $("<input type='text' value='reading' fieldtype='array' name='hobby'></input>");
      $("#person").append(hobby);
      hobby.sync();

      expect(person.hobby).to(be_undefined);
      expect(person.hobbies).to_not(be_undefined);
      expect(person.hobbies.length).to(equal, 1);
      expect(person.hobbies[0].state()).to(equal, "reading");
    });

    it("should add field to array if the name is supposed to be of array type", function() {
      expect(person.emails.length).to(equal, 1);

      var anotherEmail = $("<input type='text' value='another@my.com' name='email'></input>");
      $("#person").append(anotherEmail);
      anotherEmail.sync();

      expect(person.email).to(be_undefined);
      expect(person.emails.length).to(equal, 2);
      expect(person.emails[1].state()).to(equal, "another@my.com");
    });

    it("should add field to array once even if call sync twice", function() {
      expect(person.emails.length).to(equal, 1);

      var anotherEmail = $("<input type='text' value='another@my.com' name='email'></input>");
      $("#person").append(anotherEmail);
      anotherEmail.sync();
      anotherEmail.sync();

      expect(person.email).to(be_undefined);
      expect(person.emails.length).to(equal, 2);
    });

    it("should add part type field to array if the name is supposed to be of array type", function() {
      expect(person.contacts.length).to(equal, 1);

      var anotherContact = $("<div part='' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
      $("#person").append(anotherContact);
      anotherContact.sync();

      expect(person.contact).to(be_undefined);
      expect(person.contacts.length).to(equal, 2);
      expect(person.contacts[1].state()).to(equal_state, {number: "111", type: "home"});
    });
    
    it("should trigger state change event handler on part if it's changed", function() {
      var count = 0;
      person.stateChange(function(s){
        expect(s.education).to(equal, "college");
        count++;
      })
      
      var edu = $("<select name='education'><option selected>high school</option><option>college</option></select>");
      person.title.after(edu);
      edu.sync();
      expect(count).to(equal, 0);
      
      person.education.state("college");
      
      expect(count).to(equal, 1);
    });

  });

  describe("Remove Dom Dynamically", function() {

    it("should remove field accordingly", function() {
      person.container.find("input[name=name]").remove();
      person.sync();

      expect(person.has("name")).to(be_false);
      expect(person.name).to(be_undefined);
    });

    it("should remove item in array field accordingly", function() {
      var anotherEmail = $("<input type='text' name='email'></input>");
      $("#person").append(anotherEmail);

      person = $("#person").part();
      expect(person.emails.length).to(equal, 2);

      anotherEmail.remove();
      person.sync();

      expect(person.emails).to_not(be_undefined);
      expect(person.emails.length).to(equal, 1);
      expect(person.emails[0].state()).to(equal, "luning.tw@gmail.com");
    });

    it("should remove the array field associated with no container if it becomes empty", function() {
      $("#person input[fieldtype='array,.emails']").attr("fieldtype", "array"); // removed container setting

      person = $("#person").part();
      expect(person.emails.length).to(equal, 1);

      person.container.find("input[name=email]").remove();
      person.sync();

      expect(person.has("emails")).to(be_false);
      expect(person.emails).to(be_undefined);
    });

    it("should not remove the array field associated with a container even if it becomes empty", function() {
      expect(person.emails.length).to(equal, 1);

      person.container.find("input[name=email]").remove();
      person.sync();

      expect(person.has("emails")).to(be_true);
      expect(person.emails.length).to(equal, 0);
    });

    it("should remove part in array field accordingly", function() {
      var anotherContact = $("<div part='' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
      $("#person").append(anotherContact);

      person = $("#person").part();
      expect(person.contacts.length).to(equal, 2);

      anotherContact.remove();
      person.sync();

      expect(person.contacts.length).to(equal, 1);
      expect(person.contacts[0].state()).to(equal_state, { number: "", type: "" });
    });

    it("should remove the array field containing parts if it becomes empty", function() {
      $("#person").append("<div part='' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");

      person = $("#person").part();
      expect(person.contacts.length).to(equal, 2);

      $("#person div[name=contact]").remove();
      person.sync();

      expect(person.has("contacts")).to(be_false);
      expect(person.contacts).to(be_undefined);
    });
  });
});
</script>
</body>
</html>