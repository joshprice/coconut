<html>
<head>
  <title>Part DOM Sync Spec</title>
  <script src="../lib/jquery-1.3.2.js"></script>
  <script src="lib/screw.dependencies.js"></script>
  <script src="lib/test.helper.js"></script>
  <script src="../src/jquery.parcel.js"></script>
</head>
<body>

<div id="fixture">
  <div id="person">
    <input type="text" value="luning" name="name"></input>
    <select name="title">
      <option selected="selected">please select</option>
      <option>Mr</option>
      <option>Mrs</option>
    </select>
    <div>
      <input type="radio" value="Male" checked="checked" name="gender">Male</input>
      <input type="radio" value="Female" name="gender">Female</input>
    </div>
    <div field="part" name="dob">
      <select name="day">
        <option selected="selected">please select</option>
        <option>01</option>
        <option>02</option>
      </select>
      <select name="month">
        <option selected="selected">please select</option>
        <option>Jan</option>
        <option>Feb</option>
      </select>
      <select name="year">
        <option selected="selected">please select</option>
        <option>1990</option>
        <option>1991</option>
      </select>
    </div>
    <input id="nationality" type="text" someproperty="nationality"></input>
    <input id="id_city" type="text" fieldname="city"></input>
    <div name="emails" field="arraypart,email">
      <input type="text" value="luning.tw@gmail.com" name="email"></input>
    </div>
    <div name="contacts" field="arraypart,contact">
      <div field="part" name="contact">
        <input type="text" name="number"></input>
        <input type="text" name="type"></input>
      </div>
    </div>
    <div id="adiv">
    </div>
  </div>
  <input id="randomInput" type="text"></input>
</div>

<script type="text/javascript">
Screw.Unit(function() {

  var fixtureHtml = $("#fixture").html();

  before(function() {
    $("#fixture").html(fixtureHtml);
  });

  describe("Add DOM Dynamicly", function() {
    it("should add field if applicable", function() {
      var person = $("#person").part();
      var edu = $("<input type='text' name='education'></input>");
      person.title.after(edu);
      edu.sync();

      person.education.state("college");
      expect(person.education.state()).to(equal, "college");
    });

    it("should add field once even if call sync twice", function() {
      var person = $("#person").part();
      var edu = $("<input type='text' name='education'></input>");
      person.title.after(edu);
      edu.sync();
      edu.sync();

      person.education.state("college");
      expect(person.education.state()).to(equal, "college");
    });

    it("should add field with proper field order", function() {
      var person = $("#person").part();
      var edu = $("<input type='text' name='education'></input>");
      person.title.after(edu);
      edu.sync();

      expect(person.fieldIndex("education")).to(equal, person.fieldIndex("title") + 1);
    });

    it("should add part type field if applicable, and in correct order", function() {
      var person = $("#person").part();
      var edu = $("<div field='part' name='education'><input type='text' name='college'></input></div>");
      person.title.after(edu);
      edu.sync();

      person.education.state({college: "UTS"});

      expect(person.education.state()).to(equal_state, {college: "UTS"});
      expect(person.fieldIndex("education")).to(equal, person.fieldIndex("title") + 1);
    });

    it("should create array field if 'field' property is setted to 'arraypart'", function() {
      var person = $("#person").part();
      var hobby = $("<div field='arraypart,hobby' name='hobbies'><input type='text' value='reading' name='hobby'></input></div>");
      $("#person").append(hobby);
      hobby.sync();

      expect(person.hobby).to(be_undefined);
      expect(person.hobbies).to_not(be_undefined);
      expect(person.hobbies.items.length).to(equal, 1);
      expect(person.hobbies.items[0].state()).to(equal, "reading");
    });

    it("should add field to array if the name is supposed to be of array type", function() {
      var person = $("#person").part();
      expect(person.emails.items.length).to(equal, 1);

      var anotherEmail = $("<input type='text' value='another@my.com' name='email'></input>");
      $("#person div[name=emails]").append(anotherEmail);
      anotherEmail.sync();

      expect(person.email).to(be_undefined);
      expect(person.emails.items.length).to(equal, 2);
      expect(person.emails.items[1].state()).to(equal, "another@my.com");
    });

    it("should add field to array once even if call sync twice", function() {
      var person = $("#person").part();
      expect(person.emails.items.length).to(equal, 1);

      var anotherEmail = $("<input type='text' value='another@my.com' name='email'></input>");
      $("#person div[name=emails]").append(anotherEmail);
      anotherEmail.sync();
      anotherEmail.sync();

      expect(person.email).to(be_undefined);
      expect(person.emails.items.length).to(equal, 2);
    });

    it("should add part type field to array if the name is supposed to be of array type", function() {
      var person = $("#person").part();
      expect(person.contacts.items.length).to(equal, 1);

      var anotherContact = $("<div field='part' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
      $("#person div[name=contacts]").append(anotherContact);
      anotherContact.sync();

      expect(person.contact).to(be_undefined);
      expect(person.contacts.items.length).to(equal, 2);
      expect(person.contacts.items[1].state()).to(equal_state, {number: "111", type: "home"});
    });

    it("should fire change event on the DOM soon after its adding", function() {
      var person = $("#person").part();
      var count = 0;
      person.change(function(e){
        expect($(e.target).val()).to(equal, "high school");
        count++;
      })
      
      var edu = $("<select name='education'><option selected>high school</option><option>college</option></select>");
      person.title.after(edu);
      edu.sync();
      
      expect(count).to(equal, 1);
    });
    
    it("should trigger state change event handler on part after the newly added DOM is changed", function() {
      var person = $("#person").part();
      var added = false;
      var count = 0;
      person.stateChange(function(s){
        if(added){
          expect(s.education).to(equal, "college");
          count++;
        }
      })
      
      var edu = $("<select name='education'><option selected>high school</option><option>college</option></select>");
      person.title.after(edu);
      edu.sync();

      added = true;
      person.education.state("college");
      expect(count).to(equal, 1);
    });    
  });

  describe("Remove DOM Dynamically", function() {

    it("should remove field accordingly", function() {
      var person = $("#person").part();
      person.find("input[name=name]").remove();
      person.sync();

      expect(person.hasField("name")).to(be_false);
      expect(person.name).to(be_undefined);
    });

    it("should remove item in array field accordingly", function() {
      var anotherEmail = $("<input type='text' name='email'></input>");
      $("#person div[name=emails]").append(anotherEmail);

      var person = $("#person").part();
      expect(person.emails.items.length).to(equal, 2);

      anotherEmail.remove();
      person.sync();

      expect(person.emails).to_not(be_undefined);
      expect(person.emails.items.length).to(equal, 1);
      expect(person.emails.items[0].state()).to(equal, "luning.tw@gmail.com");
    });

    it("should not remove the array field itself even if it becomes empty", function() {
      var person = $("#person").part();
      expect(person.emails.items.length).to(equal, 1);

      person.find("input[name=email]").remove();
      person.sync();

      expect(person.hasField("emails")).to(be_true);
      expect(person.emails.items.length).to(equal, 0);
    });

    it("should remove part in array field accordingly", function() {
      var anotherContact = $("<div field='part' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");
      $("#person div[name=contacts]").append(anotherContact);

      var person = $("#person").part();
      expect(person.contacts.items.length).to(equal, 2);

      anotherContact.remove();
      person.sync();

      expect(person.contacts.items.length).to(equal, 1);
      expect(person.contacts.items[0].state()).to(equal_state, { number: "", type: "" });
    });

    it("should not remove the array field itself originally containing parts even if it becomes empty", function() {
      $("#person div[name=contacts]").append("<div field='part' name='contact'><input type='text' value='111' name='number'></input><input type='text' value='home' name='type'></input></div>");

      var person = $("#person").part();
      expect(person.contacts.items.length).to(equal, 2);

      $("#person div[name=contact]").remove();
      person.sync();

      expect(person.hasField("contacts")).to(be_true);
      expect(person.contacts.items.length).to(equal, 0);
    });

    it("should fire change event on the closest original parent which is still alive soon after the removal", function() {
      var aDiv = $("#person div[id=adiv]").append("<select name='education'><option selected>high school</option><option>college</option></select>");

      var person = $("#person").part();

      var count = 0;
      person.change(function(e){
        expect(e.target).to(equal, aDiv[0]);
        count++;
      })
      
      person.education.remove();
      person.sync();
      
      expect(count).to(equal, 1);
    });
    
    it("should fire change event on the Array field container after one of its sub fields is removed", function() {
      // has 2 emails
      var emailsDiv = $("#person div[name=emails]").append("<input type=text name=email></input>");
      var person = $("#person").part();

      var count = 0;
      person.change(function(e){
        expect(e.target).to(equal, emailsDiv[0]);
        count++;
      })
      
      person.emails.items[0].remove();
      person.sync();
      
      expect(count).to(equal, 1);
    });
    
    it("should fire change event on the Array field container after removing the last sub field", function() {
      var person = $("#person").part();

      var count = 0;
      person.change(function(e){
        expect(e.target).to(equal, person.emails.get(0));
        count++;
      })
      
      person.emails.items[0].remove();
      person.sync();
      
      expect(person.emails.items.length).to(equal, 0);
      expect(count).to(equal, 1);
    });
    
    it("should fire change event on parent DOM after removing array field", function() {
      // TODO, _parentsSnap is not stored on container yet.
    });
    
    it("should fire change event on parent DOM after removing a part as field", function() {
      // TODO, _parentsSnap is not stored on part dom yet.
    });
  });
});
</script>
</body>
</html>