<html>
<head>
  <title>Build Part with Field Spec</title>
  <script src="../lib/jquery-1.3.2.js"></script>
  <script src="screw.unit.dependencies.js"></script>
  <script src="test_extensions.js"></script>
  <script src="../src/jquery.coconut.js"></script>
</head>
<body>

<div id="fixture">
  <div id="person">
    <input type="text" value="luning" name="name"></input>
    <select name="title">
      <option selected="selected">please select</option>
      <option>Mr</option>
      <option>Mrs</option>
    </select>
    <div>
      <input type="radio" value="Male" checked="checked" name="gender">Male</input>
      <input type="radio" value="Female" name="gender">Female</input>
    </div>
    <div part="" name="dob">
      <select name="day">
        <option selected="selected">please select</option>
        <option>01</option>
        <option>02</option>
      </select>
      <select name="month">
        <option selected="selected">please select</option>
        <option>Jan</option>
        <option>Feb</option>
      </select>
      <select name="year">
        <option selected="selected">please select</option>
        <option>1990</option>
        <option>1991</option>
      </select>
    </div>
    <input id="nationality" type="text" someproperty="nationality"></input>
    <input id="id_city" type="text" fieldname="city"></input>
    <div class="emails">
      <input type="text" fieldtype="array,.emails" value="luning.tw@gmail.com" name="email"></input>
    </div>
    <div part="" fieldtype="array" name="contact">
      <input type="text" name="number"></input>
      <input type="text" name="type"></input>
    </div>
  </div>
  <input id="randomInput" type="text"></input>
</div>

<script type="text/javascript">
Screw.Unit(function() {

  var fixtureHtml = $("#fixture").html();

  before(function() {
    $("#fixture").html(fixtureHtml);
  });

  describe("Build Part", function() {
    it("should capture text input in dom", function() {
      var person = $("#person").part();
      expect(person.name.state()).to(equal, "luning");
    });

    it("should capture select in dom", function() {
      var person = $("#person").part();
      person.title.state("Mrs");
      expect(person.title.state()).to(equal, "Mrs");
    });

    it("should capture radio in dom", function() {
      var person = $("#person").part();
      person.gender.state("Female");
      expect(person.gender.state()).to(equal, "Female");
    });

    it("should ensure unique field name", function() {
      $("select[name=title]").attr("name", "name");

      try{
        var person = $("#person").part();
        expect(true).to(be_false);
      } catch (ex){
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should use id as field name if name property is not provided", function() {
      var person = $("#person").part();
      person.nationality.state("OZ");
      expect(person.nationality.state()).to(equal, "OZ");
    });

    it("should use field name defined by 'fieldname' property in dom", function() {
      var person = $("#person").part();
      expect(person.hasOwnProperty("id_city")).to(be_false);

      person.city.state("sydney");
      expect(person.city.state()).to(equal, "sydney");
    });

    it("should ignore dom element if field name can not be determined", function() {
      var nationalityDom = $("#nationality").removeAttr("id").get(0);

      var person = $("#person").part();
      expect($.inArray(nationalityDom, person.get())).to(equal, -1);
    });

    it("should not create convenient field accessor if it will override existng property of part", function() {
      $("select[name=title]").attr("name", "isDirty");

      var person = $("#person").part();
      expect(person.isDirty.state).to(be_undefined);
      expect($.isFunction(person.isDirty)).to(be_true);
    });

    it("should capture hidden dom element", function() {
      // TODO :
    });

    it("should ignore hidden template dom element", function() {
      // TODO :
    });
  });

  describe("Build Part with Array Type Field", function() {

    it("should build field of array type for element if 'fieldtype' property is setted to 'array' in dom", function() {
      var person = $("#person").part();

      expect(person.email).to(be_undefined);
      expect(person.emails.length).to(equal, 1);
      expect(person.emails[0].state()).to(equal, "luning.tw@gmail.com");

      expect(person.state()).to(contain_object, {emails:["luning.tw@gmail.com"]});
    });

    it("should add the following fields to array if the name is supposed to be of array type", function() {
      $("#person").append("<input type='text' name='email'></input>");

      var person = $("#person").part();
      expect(person.email).to(be_undefined);
      expect(person.emails.length).to(equal, 2);

      var s = {emails: ["one@my.com", "another@my.com"]};
      person.state(s);
      expect(person.state()).to(contain_object, s);
    });

    it("should build array field of part type", function() {
      var person = $("#person").part();
      expect(person.contact).to(be_undefined);
      expect(person.contacts.length).to(equal, 1);

      var s = {contacts: [{number: "123456789", type: "office"}]};
      person.state(s)
      expect(person.state()).to(contain_object, s);
    });

    it("should build array field with container if specified in 'fieldtype' property", function() {
      var person = $("#person").part();

      expect(person.emails.container[0]).to(equal, $("#person div.emails")[0]);
    });

    it("should build array field without container if not specified in 'fieldtype' property", function() {
      var person = $("#person").part();

      expect(person.contacts.container).to(be_undefined);
    });
  });

  describe("Build Part with Another Part as Field", function() {
    it("should pick part specified in dom as field of parent part", function() {
      var person = $("#person").part();
      var dobState = {day: "01", month: "Feb", year: "1991"};
      person.dob.state(dobState);

      expect(person.dob.state()).to(equal_object, dobState);
      expect(person.day).to(be_undefined);
      expect(person.month).to(be_undefined);
      expect(person.year).to(be_undefined);
    });

    it("should pick constructor behaviour specified in dom", function() {
      window.Dob = function(){
        this.description = function(){
          return this.day.state() + " " + this.month.state() + " " + this.year.state();
        }
      };

      $("div[name=dob]").attr("part", "Dob");

      var person = $("#person").part();
      person.dob.state({day: "01", month: "Feb", year: "1991"});

      expect(person.dob.description()).to(equal, "01 Feb 1991");
    });
  });

  describe("State Operations", function() {
    it("should get/set state of a part", function() {
      var person = $("#person").part();
      var state = { name: "josh", title: "Mrs", gender: "Male", nationality: "OZ", city: "sydney" };
      person.state(state);
      expect(person.state()).to(contain_object, state);
    });

    it("should be dirty if any field is changed after creation", function() {
      var person = $("#person").part();
      expect(person.isDirty()).to(be_false);

      person.name.state(person.name.state()); // setting without change
      expect(person.isDirty()).to(be_false);

      person.name.state("smith");
      expect(person.isDirty()).to(be_true);
    });

    it("should reset initial state", function() {
      var person = $("#person").part();
      var initialState = person.state();

      person.state({ name: "josh", title: "Mrs", gender: "Male", nationality: "OZ", city: "sydney" });

      person.resetState();
      expect(person.state()).to(equal_object, initialState);
    });

    it("should reset initial state with specific fields", function() {
      var person = $("#person").part();
      var initialState = person.state();
      var tempState = { name: "josh", title: "Mrs", gender: "Male", nationality: "OZ", city: "sydney" };
      person.state(tempState);

      person.resetState("name", "title");
      var finalState = person.state();

      expect(finalState.name).to(equal, initialState.name);
      expect(finalState.title).to(equal, initialState.title);

      expect(finalState.gender).to(equal, tempState.gender);
      expect(finalState.nationality).to(equal, tempState.nationality);
      expect(finalState.city).to(equal, tempState.city);
    });

    it("should not reset state with non-exist field", function() {
      var person = $("#person").part();

      try{
        person.resetState("notexist");
        expect(true).to(be_false);
      } catch(ex){
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should know need or not to update this part with another state", function() {
      var person = $("#person").part();

      expect(person.needUpdateWith({name: "smith"})).to(be_true);
      expect(person.needUpdateWith({name: "luning"})).to(be_false);
    });

    it("should be able to capture state even after construction", function() {
      var person = $("#person").part()
              .state({name: "smith"})
              .captureState()
              .resetState();

      expect(person.name.state()).to(equal, "smith");
    });

    describe("State of Composite Part", function() {

      it("should get/set state of object hierarchy", function() {
        var person = $("#person").part();
        var dobState = {day: "01", month: "Feb", year: "1991"};

        person.state({ dob: dobState });
        expect(person.state()).to(contain_object, {dob: dobState});
      });

      it("should get/set state of flaten object", function() {
          // TODO : expect(true).to(be_false);
      });

    });

  });

  describe("Field Operations", function() {

    it("should set up field order", function() {
      var person = $("#person").part(function Person(){
        this.orderFields("gender", "title", "name");
      });
      expect(person.index("gender")).to(equal, person.index("title") - 1);
      expect(person.index("title")).to(equal, person.index("name") - 1);
    });

    it("should not set up field order with invalid names", function() {
      try{
        var person = $("#person").part(function Person(){
          this.orderFields("gender", "invalidname");
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should add field ignored during construction", function() {
      $("#nationality").removeAttr("id"); // #nationality will be ignored

      var person = $("#person").part(function Person(){
        this.addFields({
          nationality: "input[someproperty=nationality]"
        });
      });

      person.nationality.state("OZ");
      expect(person.nationality.state()).to(equal, "OZ");
    });

    it("should not add field for dom element which is already captured by other field", function() {
      try{
        var person = $("#person").part(function Person(){
          this.addFields({
            myField: "#nationality"
          });
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should not add field without matched dom element", function() {
      try{
        var person = $("#person").part(function Person(){
          this.addFields({
            notexist: "#notexist"
          });
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should not add field with duplicated name", function() {
      $("#nationality").removeAttr("id"); // #nationality will be ignored

      try{
        var person = $("#person").part(function Person(){
          this.addFields({
            name: "[someproperty=nationality]"
          });
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

  });
});
</script>
</body>
</html>