<html>
<head>
	<title>Javascript Tests</title>
	<script src="../lib/jquery-1.3.2.js"></script>
	<script src="screw.unit.dependencies.js"></script>
	<script src="test_extensions.js"></script>
	<script src="../src/coconut.js"></script>
</head>
<body>

<div id="fixture">
	<div id="part1">
		<div id="container">
			<span id="span1"></span>
			<input id="part1_field" type="text"></input>
		</div>
	</div>
	<div id="part2">
		<span id="span"></span>
		<input id="part2_field" type="text" value="DEFAULT"></input>
		<select id="dropdown">
			<option selected="selected">please select</option>
			<option>SOMEVAL</option>
		</select>
		<div>
			<input id="radio1" type="radio" value="YES" name="group">Yes</input>
			<input id="radio2" type="radio" value="NO" name="group" checked="checked">No</input>
		</div>
		<div>
			<input id="radio21" type="radio" value="OPTION1" name="group2">1</input>
			<input id="radio22" type="radio" value="OPTION2" name="group2" checked="checked">2</input>
			<input id="radio23" type="radio" value="OPTION3" name="group2">3</input>
		</div>
		<div>
			<input id="radio3" type="radio" value="YES" name="group3">Yes</input>
			<input id="radio4" type="radio" value="NO" name="group3">No</input>
		</div>
	</div>
	
</div>

<script type="text/javascript">

	function Part1() {
		StateAware.call(this);
		this.setupModelFields({ field: "#part1_field" });
		this.aggregateFieldEvent("change");
		this.setupInitialState();
	}
	$.extend(Part1.prototype, StateAware.prototype, {});

	function Part2() {
		StateAware.call(this);
		this.setupModelFields({
			field:		"#part2_field",
			dropdown:	"#dropdown",
			radios:		":radio[name=group]",
			radios2:	":radio[name=group2]",
			radios3:	":radio[name=group3]"
		});
		
		this.setupDerivedFields({
			span: "#span"
		});
		
		this.aggregateFieldEvent("change");
		this.setupInitialState();
	}
	$.extend(Part2.prototype, StateAware.prototype, {});

	function PartWithDerivedField() {
		StateAware.call(this);
		this.setupModelFields({ field: "#part1_field" });
		this.setupDerivedFields({ span: "#span1" });
		
		this.aggregateFieldEvent("change");
		this.setupInitialState();

		this.copyOfField = this.createDerivedField(this.field, function() {
			return this.field.value(); // normally this would be some transform of the original value
		});
	}
	$.extend(PartWithDerivedField.prototype, StateAware.prototype, {});

	Screw.Unit(function() {

		var fixtureHtml = $("#fixture").html();

		before(function() {
			$("#fixture").html(fixtureHtml);
			$().unbind("Part1.change"); $().unbind("Part2.change"); $().unbind("PartWithDerivedField.change");
		});

		describe("Changing a Part with dependent Parts", function() {
			it("should reset text field to default value", function() {
				var part = new Part1();
				var targetPart = new Part2();

				part.resets(targetPart, ["field"]);

				targetPart.field.value("whatever");
				part.field.value("whatever").change();

				expect(targetPart.field.value()).to(equal, "DEFAULT");
			});

			it("should reset dropdown to 'please select' if dependent element changes", function() {
				var part = new Part1();
				var targetPart = new Part2();

				part.resets(targetPart, ["dropdown"]);

				targetPart.dropdown.value("SOMEVAL");
				part.field.value("new value").change();

				expect(targetPart.dropdown.value()).to(equal, "please select");
			});

			it("should reset radio button groups to default values", function() {
				var part = new Part1();
				var targetPart = new Part2();

				part.resets(targetPart, ["radios", "radios2", "radios3"]);

				targetPart.setState({ radios: "YES", radios2: "OPTION1", radios3: "YES" });

				part.setState({ field: "new" });

				expect(targetPart.getState()).to(contain_object, { radios: "NO", radios2: "OPTION2", radios3: null });
			});

			it("should update dependent MODEL/DERIVED fields by a DERIVED field", function() {
				var part = new PartWithDerivedField();
				var targetPart = new Part2();

				part.changes(targetPart, { copyOfField: "field" });
				part.changes(targetPart, { copyOfField: "span" });

				part.setState({ field: "GOOD" });

				expect(targetPart.field.value()).to(equal, "GOOD");
				expect(targetPart.span.text()).to(equal, "GOOD");
			});

			it("should update dependent MODEL/DERIVED fields by a MODEL field", function() {
				var part = new PartWithDerivedField();
				var targetPart = new Part2();

				part.changes(targetPart, { field: "field" });
				part.changes(targetPart, { field: "span" });

				part.setState({ field: "GOOD" });

				expect(targetPart.field.value()).to(equal, "GOOD");
				expect(targetPart.span.text()).to(equal, "GOOD");
			});

			it("should update dependent input specified by selector by a MODEL field", function() {
				var part = new Part2();

				part.changes(null, { field: "#part1_field" });

				part.setState({ field: "GOOD" });

				expect($("#part1_field").val()).to(equal, "GOOD");
			});

			it("should update dependent input specified by selector by a DERIVED field", function() {
				var part = new PartWithDerivedField();

				part.changes(null, { copyOfField: "#span" });

				part.setState({ field: "GOOD" });

				expect($("#span").text()).to(equal, "GOOD");
			});

			it("should update dependent field with specific event indicating a change", function() {
				var part = new Part1();
				var targetPart = new Part2();

				part.changes(targetPart, { field: "field" }, "blur");

				part.field.value("VALUE").blur().change();

				expect(targetPart.field.value()).to(equal, "VALUE");
			});
		});

	});
</script>
</body>
</html>
