<html>
<head>
  <title>Part Operation Spec</title>
  <script src="../lib/jquery-1.3.2.js"></script>
  <script src="lib/screw.dependencies.js"></script>
  <script src="lib/test.helper.js"></script>
  <script src="../src/jquery.coconut.js"></script>
</head>
<body>

<div id="fixture">
  <div id="person">
    <input type="text" value="luning" name="name"></input>
    <select name="title">
      <option selected="selected">please select</option>
      <option>Mr</option>
      <option>Mrs</option>
    </select>
    <div>
      <input type="radio" value="Male" checked="checked" name="gender">Male</input>
      <input type="radio" value="Female" name="gender">Female</input>
    </div>
    <div part="" name="dob">
      <select name="day">
        <option selected="selected">please select</option>
        <option>01</option>
        <option>02</option>
      </select>
      <select name="month">
        <option selected="selected">please select</option>
        <option>Jan</option>
        <option>Feb</option>
      </select>
      <select name="year">
        <option selected="selected">please select</option>
        <option>1990</option>
        <option>1991</option>
      </select>
    </div>
    <input id="nationality" type="text" someproperty="nationality"></input>
    <input id="id_city" type="text" fieldname="city"></input>
    <div fieldtype="virtual" name="contactInfo">
      <div class="emails">
        <input type="text" fieldtype="array,.emails" value="luning.tw@gmail.com" name="email"></input>
      </div>
      <div part="" fieldtype="array" name="contact">
        <input type="text" name="number"></input>
        <input type="text" name="type"></input>
      </div>
    </div>
  </div>
  <input id="randomInput" type="text"></input>
</div>

<script type="text/javascript">
Screw.Unit(function() {

  var fixtureHtml = $("#fixture").html();
  var person;

  before(function() {
    $("#fixture").html(fixtureHtml);

    person = $("#person").part();
  });

  describe("Reset State", function() {
  
      it("should reset initial state", function() {
        var initialState = person.state();

        person.state({ name: "Josh", title: "Mr", gender: "Male", nationality: "OZ", city: "sydney" });

        person.resetState();
        expect(person.state()).to(equal_state, initialState);
      });

      it("should reset initial state with specific fields", function() {
        var initialState = person.state();
        var tempState = { name: "Josh", title: "Mr", gender: "Male", nationality: "OZ", city: "sydney" };
        person.state(tempState);

        person.resetState("name", "title");
        var finalState = person.state();

        expect(finalState.name).to(equal, initialState.name);
        expect(finalState.title).to(equal, initialState.title);

        expect(finalState.gender).to(equal, tempState.gender);
        expect(finalState.nationality).to(equal, tempState.nationality);
        expect(finalState.city).to(equal, tempState.city);
      });
      
      it("should reset initial state with fields in a jQuery container(Virtual Field)", function() {
        expect(person.gender.state()).to(equal, "Male");

        var tempState = { name: "Jane", title: "Mrs", gender: "Female", nationality: "OZ", city: "sydney" };
        person.state(tempState);

        var genderContainer = person.gender.closest("div"); // the div contains the two gender radios
        person.resetState(genderContainer);

        expect(person.gender.state()).to(equal, "Male");
        delete tempState.gender;
        expect(person.state()).to(contain_state, tempState);
      });

      it("should not reset state with non-exist field", function() {
        try{
          person.resetState("notexist");
          expect(true).to(be_false);
        } catch(ex){
          expect(ex.toString()).to(match, "CoconutError");
        }
      });

  });
  
  describe("Capture State", function() {
    it("should be able to capture state even after construction", function() {
      person.state({name: "smith"})
            .captureState()
            .resetState();

      expect(person.name.state()).to(equal, "smith");
    });
  });
  
  describe("Order Fields", function() {
    it("should set up field order", function() {
      person = $("#person").part(function Person(){
        this.orderFields("gender", "title", "name");
      });
      expect(person.index("gender")).to(equal, person.index("title") - 1);
      expect(person.index("title")).to(equal, person.index("name") - 1);
    });

    it("should not set up field order with invalid names", function() {
      try{
        $("#person").part(function Person(){
          this.orderFields("gender", "invalidname");
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });
  });

  describe("Add Fields", function() {
    it("should add field ignored during construction", function() {
      $("#nationality").removeAttr("id"); // #nationality will be ignored

      person = $("#person").part(function Person(){
        this.addFields({
          nationality: "input[someproperty=nationality]"
        });
      });

      person.nationality.state("OZ");
      expect(person.nationality.state()).to(equal, "OZ");
    });

    it("should not add field for dom element which is already captured by other field", function() {
      try{
        $("#person").part(function Person(){
          this.addFields({
            myField: "#nationality"
          });
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should not add field without matched dom element", function() {
      try{
        $("#person").part(function Person(){
          this.addFields({
            notexist: "#notexist"
          });
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });

    it("should not add field with duplicated name", function() {
      $("#nationality").removeAttr("id"); // #nationality will be ignored

      try{
        $("#person").part(function Person(){
          this.addFields({
            name: "[someproperty=nationality]"
          });
        });
        expect(true).to(be_false);
      } catch(ex) {
        expect(ex.toString()).to(match, "CoconutError");
      }
    });
  });
  
  describe("getState", function() {
    it("should get state of this part by passing in this part as context", function() {
      expect(person.getState(person)).to(equal_state, person.state());
    });
  });

});
</script>
</body>
</html>